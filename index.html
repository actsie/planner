<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Calm - Your Gentle Digital Planner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #faf8f3;
            color: #4a5568;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            flex: 1;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
        }

        h1 {
            color: #7c9885;
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
        }

        .quote {
            font-style: italic;
            color: #718096;
            font-size: 1.1rem;
            margin-top: 1rem;
            min-height: 2rem;
        }

        .main-content {
            display: grid;
            gap: 2rem;
            grid-template-columns: 1fr 1fr;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .card h2 {
            color: #7c9885;
            font-size: 1.3rem;
            font-weight: 400;
            margin-bottom: 1rem;
        }

        /* To-Do List Styles */
        .todo-input-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        #taskInput {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e8dfd6;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        #taskInput:focus {
            outline: none;
            border-color: #b5a99f;
        }

        #addTask {
            background: #b5a99f;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }

        #addTask:hover {
            background: #9f8e82;
        }

        #taskList {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .task {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #f5f5f5;
            transition: background 0.2s;
            position: relative;
        }

        .task.active-task {
            flex-direction: column;
            align-items: flex-start;
            background: #DDEDE2;
            border-left: 4px solid #B5CDBA;
            box-shadow: 0 0 6px rgba(180, 200, 170, 0.4);
        }

        .task:hover {
            background: #faf8f3;
        }

        .task input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 0.75rem;
            cursor: pointer;
        }

        .task span {
            flex: 1;
            font-size: 0.95rem;
        }

        .task.completed span {
            text-decoration: line-through;
            color: #a0aec0;
        }

        .delete-task {
            background: none;
            border: none;
            color: #e2b1b1;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .timer-task {
            background: none;
            border: none;
            color: #7c9885;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .task:hover .delete-task,
        .task:hover .timer-task {
            opacity: 1;
        }

        .task-time-info {
            font-size: 11px;
            color: #999;
            margin-left: 0.5rem;
        }

        .active-tag {
            background: #DDEDE2;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        /* Mood Tracker Styles */
        .mood-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 1rem;
        }

        .emoji {
            font-size: 2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
            position: relative;
        }

        .emoji:hover {
            transform: scale(1.1);
            background: #f5f5f5;
        }

        .emoji.selected {
            background: #e8dfd6;
            transform: scale(1.15);
        }

        .mood-label {
            font-size: 0.75rem;
            text-align: center;
            margin-top: 0.25rem;
            color: #718096;
        }

        .mood-history {
            font-size: 0.9rem;
            color: #718096;
            margin-top: 1rem;
        }

        .mood-timeline {
            font-size: 0.75rem;
            color: #999;
            margin-top: 0.5rem;
            max-height: 100px;
            overflow-y: auto;
        }

        .mood-timeline-entry {
            margin-bottom: 0.25rem;
        }

        .link-button {
            background: none;
            border: none;
            padding: 0;
            color: #718096;
            cursor: pointer;
            font-size: 0.75rem;
        }

        /* Timer Styles */
        .timer-display {
            font-size: 3rem;
            text-align: center;
            color: #7c9885;
            margin: 1rem 0;
            font-weight: 300;
            font-variant-numeric: tabular-nums;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .timer-btn {
            background: #c9b3a3;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }

        .timer-btn:hover {
            background: #b39b8b;
        }

        .timer-btn:disabled {
            background: #e2d8ce;
            cursor: not-allowed;
        }

        .timer-progress {
            width: 100%;
            height: 4px;
            background: #e8dfd6;
            border-radius: 2px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .timer-progress-bar {
            height: 100%;
            background: #7c9885;
            width: 0%;
            transition: width 1s linear;
        }

        /* Full width card for timer */
        .full-width {
            grid-column: 1 / -1;
        }

        /* Notes Section Styles */
        .notes-section {
            grid-column: 1 / -1;
            display: flex;
            gap: 1rem;
            min-height: 400px;
        }

        .notes-sidebar {
            flex: 0 0 250px;
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .notes-main {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
        }

        .notes-sidebar h3 {
            color: #7c9885;
            font-size: 1.1rem;
            font-weight: 400;
            margin-bottom: 1rem;
        }

        .add-note-btn {
            width: 100%;
            background: #c9b3a3;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
            margin-bottom: 1rem;
        }

        .add-note-btn:hover {
            background: #b39b8b;
        }

        .notes-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow-y: auto;
            max-height: 300px;
        }

        .note-item {
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            border: 2px solid transparent;
            position: relative;
        }

        .note-item:hover {
            background: #faf8f3;
        }

        .note-item.active {
            background: #e8dfd6;
            border-color: #c9b3a3;
        }

        .note-item-title {
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
        }

        .note-item-date {
            font-size: 0.75rem;
            color: #718096;
        }

        .delete-note {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            color: #e2b1b1;
            cursor: pointer;
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.2s;
            padding: 0.25rem;
        }

        .note-item:hover .delete-note {
            opacity: 1;
        }

        .note-editor {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .note-title-input {
            font-size: 1.5rem;
            color: #4a5568;
            border: none;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: transparent;
            font-weight: 500;
        }

        .note-title-input:focus {
            outline: none;
            background: #faf8f3;
            border-radius: 8px;
        }

        .note-content {
            flex: 1;
            border: 2px solid #e8dfd6;
            border-radius: 8px;
            padding: 1rem;
            font-size: 1rem;
            resize: none;
            transition: border-color 0.2s;
            font-family: inherit;
            line-height: 1.6;
        }

        .note-content:focus {
            outline: none;
            border-color: #b5a99f;
        }

        .empty-state {
            color: #718096;
            text-align: center;
            padding: 3rem;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .notes-section {
                flex-direction: column;
            }

            .notes-sidebar {
                flex: none;
            }

            .notes-list {
                max-height: 150px;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .modal h3 {
            color: #7c9885;
            margin-bottom: 1.5rem;
            font-weight: 400;
        }

        .duration-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .duration-btn {
            background: #e8dfd6;
            border: none;
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .duration-btn:hover {
            background: #c9b3a3;
            color: white;
        }

        .custom-duration {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .custom-duration input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e8dfd6;
            border-radius: 8px;
            font-size: 1rem;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }

        .modal-btn.primary {
            background: #c9b3a3;
            color: white;
        }

        .modal-btn.primary:hover {
            background: #b39b8b;
        }

        .modal-btn.secondary {
            background: #e8dfd6;
            color: #4a5568;
        }

        .modal-btn.secondary:hover {
            background: #d8cfc6;
        }

        /* Task Timer Display */
        .task-timer-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            z-index: 999;
            min-width: 250px;
        }

        .minimize-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            color: #a0aec0;
        }

        .task-progress {
            width: 100%;
            height: 4px;
            background: #e8dfd6;
            border-radius: 2px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .task-progress-bar {
            height: 100%;
            background: #7c9885;
            width: 0%;
            transition: width 1s linear;
        }

        .minimized-task-timer {
            display: none;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .minimized-task-timer .controls button {
            background: none;
            border: none;
            cursor: pointer;
            margin-left: 0.25rem;
            color: #7c9885;
            font-size: 1rem;
        }

        .floating-msg {
            font-size: 0.85rem;
            color: #a0aec0;
            margin-bottom: 0.5rem;
        }

        .task-timer-title {
            color: #7c9885;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .task-timer-time {
            font-size: 2rem;
            color: #4a5568;
            font-weight: 300;
            font-variant-numeric: tabular-nums;
        }

        .task-header {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .task-info-icon {
            background: none;
            border: 1px solid #e8dfd6;
            color: #a0aec0;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            margin-left: 0.25rem;
            cursor: pointer;
        }

        .task-info-card {
            position: absolute;
            background: #f8f1e8;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            color: #4a5568;
            display: none;
            z-index: 1000;
        }

        .task-info-card::after {
            content: '';
            position: absolute;
            top: -6px;
            left: 10px;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid #f8f1e8;
        }

        .task-info-card .info-task-name {
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        /* Done List */
        .done-section {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e8dfd6;
        }

        .done-section h3 {
            color: #a0aec0;
            font-size: 1rem;
            font-weight: 400;
            margin-bottom: 0.5rem;
        }

        .done-task {
            opacity: 0.6;
        }

        .done-task span {
            text-decoration: line-through;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Daily Calm</h1>
            <p class="quote" id="quoteDisplay"></p>
        </header>

        <div class="main-content">
            <div class="card">
                <h2>Today's Tasks</h2>
                <div class="todo-input-container">
                    <input type="text" id="taskInput" placeholder="What would you like to do today?" />
                    <button id="addTask">Add</button>
                </div>
                <ul id="taskList"></ul>
                <div id="taskInfoCard" class="task-info-card"></div>
            </div>

            <div class="card">
                <h2>How are you feeling?</h2>
                <div class="mood-container">
                    <div>
                        <div class="emoji" data-mood="😐">😐</div>
                        <div class="mood-label">meh</div>
                    </div>
                    <div>
                        <div class="emoji" data-mood="🙂">🙂</div>
                        <div class="mood-label">okay</div>
                    </div>
                    <div>
                        <div class="emoji" data-mood="😄">😄</div>
                        <div class="mood-label">good</div>
                    </div>
                    <div>
                        <div class="emoji" data-mood="😩">😩</div>
                        <div class="mood-label">tired</div>
                    </div>
                    <div>
                        <div class="emoji" data-mood="😠">😠</div>
                        <div class="mood-label">stressed</div>
                    </div>
                </div>
                <div class="mood-history" id="moodHistory"></div>
                <div class="mood-timeline" id="moodTimeline"></div>
                <button id="toggleMoodLog" class="link-button" style="display:none;">View all</button>
            </div>

            <div class="card full-width">
                <h2>Focus Timer</h2>
                <div id="floatingMsg" class="floating-msg" style="display:none;">Active timer is running elsewhere (see top-right)</div>
                <div id="minimizedTaskTimer" class="minimized-task-timer">
                    <div>
                        <span id="minTaskTitle"></span>
                        <span id="minTaskTime"></span>
                    </div>
                    <div class="controls">
                        <button onclick="pauseTaskTimer()" id="minPauseBtn">⏸️</button>
                        <button onclick="resumeTaskTimer()" id="minResumeBtn" style="display:none;">▶️</button>
                        <button onclick="cancelTaskTimer()">✖️</button>
                        <button onclick="addMoreTimeDuringRun()">➕</button>
                        <button onclick="maximizeTaskTimer()">🔼</button>
                    </div>
                    <div class="task-progress"><div class="task-progress-bar" id="minTaskProgressBar"></div></div>
                </div>
                <div class="timer-display" id="timerDisplay">25:00</div>
                <div class="timer-controls">
                    <button class="timer-btn" id="startTimer">Start</button>
                    <button class="timer-btn" id="pauseTimer" disabled>Pause</button>
                    <button class="timer-btn" id="resetTimer">Reset</button>
                </div>
                <div class="timer-progress">
                    <div class="timer-progress-bar" id="timerProgressBar"></div>
                </div>
            </div>

            <div class="notes-section">
                <div class="notes-sidebar">
                    <h3>My Notes</h3>
                    <button class="add-note-btn" id="addNoteBtn">+ Add Note</button>
                    <div class="notes-list" id="notesList"></div>
                </div>
                <div class="notes-main">
                    <div id="noteEditor" class="note-editor" style="display: none;">
                        <input type="text" class="note-title-input" id="noteTitleInput" placeholder="Note Title" />
                        <textarea class="note-content" id="noteContent" placeholder="Start writing your thoughts..."></textarea>
                    </div>
                    <div id="emptyState" class="empty-state">
                        <p>Select a note to view or create a new one</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timer Duration Modal -->
    <div class="modal" id="durationModal">
        <div class="modal-content">
            <h3>Select Timer Duration</h3>
            <div class="duration-options">
                <button class="duration-btn" onclick="selectDuration(5)">5 minutes</button>
                <button class="duration-btn" onclick="selectDuration(10)">10 minutes</button>
                <button class="duration-btn" onclick="selectDuration(25)">25 minutes</button>
            </div>
            <div class="custom-duration">
                <input type="number" id="customDuration" placeholder="Custom minutes" min="1" max="60">
                <button class="modal-btn primary" onclick="selectCustomDuration()">Start</button>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeDurationModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Task Completion Modal -->
    <div class="modal" id="completionModal">
        <div class="modal-content">
            <h3>Timer Complete! Did you finish this task?</h3>
            <div class="modal-actions">
                <button class="modal-btn primary" onclick="completeTask()">✅ Yes</button>
                <button class="modal-btn secondary" onclick="addMoreTime()">➕ Add more time</button>
                <button class="modal-btn secondary" onclick="keepTaskActive()">🕗 Not yet</button>
            </div>
        </div>
    </div>

    <!-- Task Timer Display -->
    <div class="task-timer-display" id="taskTimerDisplay" style="display: none;">
        <button class="minimize-btn" onclick="minimizeTaskTimer()">▾</button>
        <div class="task-timer-title" id="taskTimerTitle"></div>
        <div class="task-timer-time" id="taskTimerTime"></div>
        <div class="task-progress"><div class="task-progress-bar" id="taskProgressBar"></div></div>
    </div>

    <script>
        // Encouraging quotes
        const quotes = [
            "You don't have to finish, just begin.",
            "Progress, not perfection.",
            "One small step is still a step forward.",
            "You're doing better than you think.",
            "Be gentle with yourself today.",
            "It's okay to rest when you need to.",
            "You are enough, just as you are.",
            "Breathe. You've got this.",
            "Small wins are still wins.",
            "Your pace is perfect for you.",
            "Every moment is a fresh start.",
            "You're allowed to take your time."
        ];

        // Load and display random quote
        function loadQuote() {
            const quoteDisplay = document.getElementById('quoteDisplay');
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            quoteDisplay.textContent = randomQuote;
        }

        // To-Do List functionality
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        const taskList = document.getElementById('taskList');
        const taskInput = document.getElementById('taskInput');
        const addTaskButton = document.getElementById('addTask');

        // Task Timer variables
        let currentTaskIndex = null;
        let taskTimerInterval = null;
        let taskTimeRemaining = 0;
        let selectedDuration = 0;
        let taskOriginalDuration = 0;
        let isTaskPaused = false;
        let isTimerMinimized = false;
        let pinnedTaskIndex = null;

        function loadTasks() {
            taskList.innerHTML = '';

            let activeIndices = tasks.map((t, i) => i).filter(i => !tasks[i].completed);
            if (pinnedTaskIndex !== null && activeIndices.includes(pinnedTaskIndex)) {
                activeIndices = [pinnedTaskIndex, ...activeIndices.filter(i => i !== pinnedTaskIndex)];
            }

            activeIndices.forEach(idx => {
                const task = tasks[idx];
                const li = document.createElement('li');
                li.classList.add('task');

                const isActive = idx === pinnedTaskIndex && (taskTimerInterval || isTaskPaused);
                if (isActive) li.classList.add('active-task');

                const timeInfo = task.totalTime ? `Worked ${Math.round(task.totalTime / 60)} min` : '';
                const showInfo = task.totalTime || (task.sessions && task.sessions.length);
                const infoIcon = showInfo ? `<button class='task-info-icon' onclick='showTaskInfo(event, ${idx})'>i</button>` : '';
                const activeTag = isActive ? `<div class='active-tag'>⏱ Active</div>` : '';

                li.innerHTML = `
                    ${activeTag}
                    <div class='task-header'>
                        <input type='checkbox' ${task.completed ? 'checked' : ''} onchange='toggleTask(${idx})'/>
                        <span>${task.task}</span>${infoIcon}
                        <span class='task-time-info'>${timeInfo}</span>
                        <button class='timer-task' onclick='startTaskTimer(${idx})'>⏱️</button>
                        <button class='delete-task' onclick='deleteTask(${idx})'>×</button>
                    </div>
                `;

                taskList.appendChild(li);
            });
            
            // Done tasks
            const doneTasks = tasks.filter(task => task.completed);
            if (doneTasks.length > 0) {
                const doneSection = document.createElement('div');
                doneSection.classList.add('done-section');
                doneSection.innerHTML = '<h3>Done</h3>';
                
                doneTasks.forEach((task, index) => {
                    const actualIndex = tasks.indexOf(task);
                    const li = document.createElement('li');
                    li.classList.add('task', 'done-task');

                    const timeInfo = task.totalTime ? ` (Worked ${Math.round(task.totalTime / 60)} mins)` : '';
                    const showInfo = task.totalTime || (task.sessions && task.sessions.length);
                    const infoIcon = showInfo ? `<button class='task-info-icon' onclick='showTaskInfo(event, ${actualIndex})'>i</button>` : '';
                    li.innerHTML = `
                        <input type='checkbox' ${task.completed ? 'checked' : ''} onchange='toggleTask(${actualIndex})'/>
                        <span>${task.task}</span>${infoIcon}
                        <span class='task-time-info'>${timeInfo}</span>
                        <button class='delete-task' onclick='deleteTask(${actualIndex})'>×</button>
                    `;
                    doneSection.appendChild(li);
                });
                
                taskList.appendChild(doneSection);
            }
        }

        function showTaskInfo(event, index) {
            event.stopPropagation();
            const card = document.getElementById('taskInfoCard');
            const task = tasks[index];
            const total = Math.round((task.totalTime || 0) / 60);
            const last = task.sessions && task.sessions.length ? Math.round(task.sessions[task.sessions.length - 1].duration) : null;
            card.innerHTML = `
                <div class='info-task-name'>${task.task}</div>
                <div>Worked: ${total} min</div>
                ${last ? `<div>Last session: ${last} min</div>` : ''}
                <div>${task.completed ? 'Completed' : 'Not done yet'}</div>
            `;
            card.style.display = 'block';
            card.style.top = (event.target.getBoundingClientRect().bottom + window.scrollY + 6) + 'px';
            card.style.left = (event.target.getBoundingClientRect().left + window.scrollX) + 'px';
        }

        document.addEventListener('click', function(e) {
            const card = document.getElementById('taskInfoCard');
            if (card.style.display === 'block' && !card.contains(e.target)) {
                card.style.display = 'none';
            }
        });

        window.addEventListener('scroll', () => {
            document.getElementById('taskInfoCard').style.display = 'none';
        });

        function addTask() {
            const taskValue = taskInput.value.trim();
            if (taskValue) {
                tasks.push({ 
                    task: taskValue, 
                    completed: false,
                    totalTime: 0,
                    sessions: []
                });
                localStorage.setItem('tasks', JSON.stringify(tasks));
                taskInput.value = '';
                loadTasks();
            }
        }

        function toggleTask(index) {
            tasks[index].completed = !tasks[index].completed;
            localStorage.setItem('tasks', JSON.stringify(tasks));
            loadTasks();
        }

        function deleteTask(index) {
            tasks.splice(index, 1);
            localStorage.setItem('tasks', JSON.stringify(tasks));
            loadTasks();
        }

        // Add task on Enter key
        taskInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTask();
            }
        });

        addTaskButton.addEventListener('click', addTask);

        // Mood Tracker functionality
        const moodEmojis = document.querySelectorAll('.emoji');
        const moodHistory = document.getElementById('moodHistory');
        const moodTimeline = document.getElementById('moodTimeline');
        const toggleMoodLogBtn = document.getElementById('toggleMoodLog');
        let showAllMoodLog = false;

        function loadTodaysMood() {
            const todayString = new Date().toDateString();
            let moodLog = JSON.parse(localStorage.getItem('moodLog')) || [];
            const todaysEntries = moodLog.filter(e => new Date(e.date).toDateString() === todayString);

            if (moodLog.length !== todaysEntries.length) {
                moodLog = todaysEntries;
                localStorage.setItem('moodLog', JSON.stringify(moodLog));
            }

            if (todaysEntries.length) {
                const last = todaysEntries[todaysEntries.length - 1];
                moodEmojis.forEach(emoji => {
                    if (emoji.dataset.mood === last.mood) {
                        emoji.classList.add('selected');
                    }
                });
            }

            updateMoodHistory();
        }

        function formatTime(dateStr) {
            const options = { hour: 'numeric', minute: 'numeric' };
            return new Date(dateStr).toLocaleTimeString([], options);
        }

        function updateMoodHistory() {
            const moodLog = JSON.parse(localStorage.getItem('moodLog')) || [];
            const todayString = new Date().toDateString();
            const todaysEntries = moodLog.filter(entry => new Date(entry.date).toDateString() === todayString);

            moodTimeline.innerHTML = '';

            if (todaysEntries.length === 0) {
                moodHistory.textContent = 'No mood logged today';
                toggleMoodLogBtn.style.display = 'none';
                return;
            }

            const last = todaysEntries[todaysEntries.length - 1];
            moodHistory.textContent = `Today's mood: ${last.mood}`;

            const entriesToShow = showAllMoodLog ? todaysEntries : todaysEntries.slice(-3);

            entriesToShow.forEach(entry => {
                const div = document.createElement('div');
                div.classList.add('mood-timeline-entry');
                const taskInfo = entry.task ? `During "${entry.task}" (${entry.elapsed} min in)` : 'No task active';
                div.textContent = `${entry.mood} – ${formatTime(entry.date)} – ${taskInfo}`;
                moodTimeline.appendChild(div);
            });

            toggleMoodLogBtn.style.display = todaysEntries.length > 3 ? 'inline' : 'none';
            toggleMoodLogBtn.textContent = showAllMoodLog ? 'Hide' : 'View all';
        }

        moodEmojis.forEach(emoji => {
            emoji.addEventListener('click', function() {
                moodEmojis.forEach(e => e.classList.remove('selected'));
                this.classList.add('selected');

                const now = new Date();
                const todayString = now.toDateString();
                let moodLog = JSON.parse(localStorage.getItem('moodLog')) || [];

                moodLog = moodLog.filter(entry => new Date(entry.date).toDateString() === todayString);

                let taskName = null;
                let elapsed = null;
                if (taskTimerInterval && currentTaskIndex !== null) {
                    const task = tasks[currentTaskIndex];
                    if (task) {
                        taskName = task.task;
                        elapsed = Math.floor((selectedDuration * 60 - taskTimeRemaining) / 60);
                    }
                }

                moodLog.push({
                    date: now.toISOString(),
                    mood: this.dataset.mood,
                    task: taskName,
                    elapsed: elapsed
                });

                localStorage.setItem('moodLog', JSON.stringify(moodLog));
                updateMoodHistory();
            });
        });

        toggleMoodLogBtn.addEventListener('click', () => {
            showAllMoodLog = !showAllMoodLog;
            updateMoodHistory();
        });

        // Timer functionality
        let timerInterval;
        let timeRemaining = 25 * 60; // 25 minutes in seconds
        let isRunning = false;
        const totalTime = 25 * 60;

        const timerDisplay = document.getElementById('timerDisplay');
        const startBtn = document.getElementById('startTimer');
        const pauseBtn = document.getElementById('pauseTimer');
        const resetBtn = document.getElementById('resetTimer');
        const progressBar = document.getElementById('timerProgressBar');

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update progress bar
            const progress = ((totalTime - timeRemaining) / totalTime) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function startTimer() {
            if (!isRunning) {
                isRunning = true;
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                
                timerInterval = setInterval(() => {
                    if (timeRemaining > 0) {
                        timeRemaining--;
                        updateTimerDisplay();
                    } else {
                        // Timer finished
                        clearInterval(timerInterval);
                        isRunning = false;
                        startBtn.disabled = false;
                        pauseBtn.disabled = true;
                        alert('Time for a break! Great job focusing!');
                        resetTimer();
                    }
                }, 1000);
            }
        }

        function pauseTimer() {
            if (isRunning) {
                clearInterval(timerInterval);
                isRunning = false;
                startBtn.disabled = false;
                pauseBtn.disabled = true;
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            timeRemaining = 25 * 60;
            updateTimerDisplay();
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            progressBar.style.width = '0%';
        }

        startBtn.addEventListener('click', startTimer);
        pauseBtn.addEventListener('click', pauseTimer);
        resetBtn.addEventListener('click', resetTimer);

        // Notes functionality
        let notes = JSON.parse(localStorage.getItem('notes')) || [];
        let currentNoteId = null;
        let autoSaveTimeout = null;

        const notesList = document.getElementById('notesList');
        const noteEditor = document.getElementById('noteEditor');
        const emptyState = document.getElementById('emptyState');
        const noteTitleInput = document.getElementById('noteTitleInput');
        const noteContent = document.getElementById('noteContent');
        const addNoteBtn = document.getElementById('addNoteBtn');

        function generateNoteId() {
            return Date.now().toString();
        }

        function formatDate(date) {
            const options = { month: 'short', day: 'numeric', year: 'numeric' };
            return new Date(date).toLocaleDateString('en-US', options);
        }

        function loadNotes() {
            notesList.innerHTML = '';
            
            notes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            notes.forEach(note => {
                const noteItem = document.createElement('div');
                noteItem.classList.add('note-item');
                if (note.id === currentNoteId) {
                    noteItem.classList.add('active');
                }
                
                noteItem.innerHTML = `
                    <div class="note-item-title">${note.title || 'Untitled Note'}</div>
                    <div class="note-item-date">${formatDate(note.createdAt)}</div>
                    <button class="delete-note" onclick="event.stopPropagation(); deleteNote('${note.id}')">×</button>
                `;
                
                noteItem.onclick = () => selectNote(note.id);
                notesList.appendChild(noteItem);
            });
        }

        function selectNote(noteId) {
            currentNoteId = noteId;
            const note = notes.find(n => n.id === noteId);
            
            if (note) {
                noteTitleInput.value = note.title || '';
                noteContent.value = note.content || '';
                noteEditor.style.display = 'flex';
                emptyState.style.display = 'none';
                loadNotes();
            }
        }

        function createNote() {
            const newNote = {
                id: generateNoteId(),
                title: 'New Note',
                content: '',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            notes.push(newNote);
            localStorage.setItem('notes', JSON.stringify(notes));
            selectNote(newNote.id);
            loadNotes();
            noteTitleInput.focus();
            noteTitleInput.select();
        }

        function deleteNote(noteId) {
            if (confirm('Are you sure you want to delete this note?')) {
                notes = notes.filter(n => n.id !== noteId);
                localStorage.setItem('notes', JSON.stringify(notes));
                
                if (noteId === currentNoteId) {
                    currentNoteId = null;
                    noteEditor.style.display = 'none';
                    emptyState.style.display = 'block';
                }
                
                loadNotes();
            }
        }

        function autoSaveNote() {
            if (currentNoteId) {
                const note = notes.find(n => n.id === currentNoteId);
                if (note) {
                    note.title = noteTitleInput.value || 'Untitled Note';
                    note.content = noteContent.value;
                    note.updatedAt = new Date().toISOString();
                    localStorage.setItem('notes', JSON.stringify(notes));
                    loadNotes();
                }
            }
        }

        function handleNoteInput() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(autoSaveNote, 500);
        }

        // Add event listeners for notes
        addNoteBtn.addEventListener('click', createNote);
        noteTitleInput.addEventListener('input', handleNoteInput);
        noteContent.addEventListener('input', handleNoteInput);

        // Allow renaming by clicking on title
        noteTitleInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                noteContent.focus();
            }
        });

        // Task Timer Functions
        function startTaskTimer(index) {
            currentTaskIndex = index;
            document.getElementById('durationModal').classList.add('active');
        }

        function selectDuration(minutes) {
            selectedDuration = minutes;
            closeDurationModal();
            startTaskCountdown();
        }

        function selectCustomDuration() {
            const customInput = document.getElementById('customDuration');
            const minutes = parseInt(customInput.value);
            if (minutes && minutes > 0 && minutes <= 60) {
                selectedDuration = minutes;
                closeDurationModal();
                startTaskCountdown();
            }
        }

        function closeDurationModal() {
            document.getElementById('durationModal').classList.remove('active');
            document.getElementById('customDuration').value = '';
        }

        function startTaskCountdown() {
            if (currentTaskIndex === null) return;

            const task = tasks[currentTaskIndex];
            taskOriginalDuration = selectedDuration * 60;
            taskTimeRemaining = taskOriginalDuration;
            isTaskPaused = false;
            isTimerMinimized = false;
            pinnedTaskIndex = currentTaskIndex;

            const display = document.getElementById('taskTimerDisplay');
            const titleEl = document.getElementById('taskTimerTitle');
            const timeEl = document.getElementById('taskTimerTime');

            display.style.display = 'block';
            document.getElementById('minimizedTaskTimer').style.display = 'none';
            titleEl.textContent = task.task;
            document.getElementById('minTaskTitle').textContent = task.task;

            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }

            startTaskInterval();
            updateTaskTimerDisplay();
            updateFloatingMsg();
            loadTasks();
        }

        function startTaskInterval() {
            clearInterval(taskTimerInterval);
            taskTimerInterval = setInterval(() => {
                if (taskTimeRemaining > 0) {
                    taskTimeRemaining--;
                    updateTaskTimerDisplay();
                } else {
                    clearInterval(taskTimerInterval);
                    taskTimerInterval = null;
                    taskTimerComplete();
                }
            }, 1000);
        }

        function updateTaskTimerDisplay() {
            const minutes = Math.floor(taskTimeRemaining / 60);
            const seconds = taskTimeRemaining % 60;
            document.getElementById('taskTimerTime').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('minTaskTime').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            const progress = ((taskOriginalDuration - taskTimeRemaining) / taskOriginalDuration) * 100;
            document.getElementById('taskProgressBar').style.width = `${progress}%`;
            document.getElementById('minTaskProgressBar').style.width = `${progress}%`;
        }

        function taskTimerComplete() {
            // Show notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Timer Complete!', {
                    body: `Time's up for: ${tasks[currentTaskIndex].task}`,
                    icon: '⏱️'
                });
            }
            
            // Play a gentle sound (optional)
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGG2S48+OZURE');
            audio.volume = 0.3;
            audio.play().catch(() => {});
            
            pinnedTaskIndex = null;
            document.getElementById('completionModal').classList.add('active');
            loadTasks();
        }

        function logCurrentSession() {
            if (currentTaskIndex === null) return;
            const elapsed = taskOriginalDuration - taskTimeRemaining;
            if (elapsed <= 0) return;
            tasks[currentTaskIndex].totalTime = (tasks[currentTaskIndex].totalTime || 0) + elapsed;
            tasks[currentTaskIndex].sessions = tasks[currentTaskIndex].sessions || [];
            tasks[currentTaskIndex].sessions.push({
                duration: elapsed / 60,
                completedAt: new Date().toISOString()
            });
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }

        function completeTask() {
            if (currentTaskIndex === null) return;
            logCurrentSession();
            tasks[currentTaskIndex].completed = true;
            localStorage.setItem('tasks', JSON.stringify(tasks));
            closeCompletionModal();
        }

        function addMoreTime() {
            logCurrentSession();
            document.getElementById('completionModal').classList.remove('active');
            document.getElementById('durationModal').classList.add('active');
        }

        function keepTaskActive() {
            if (currentTaskIndex === null) return;
            logCurrentSession();
            closeCompletionModal();
        }

        function closeCompletionModal() {
            document.getElementById('completionModal').classList.remove('active');
            document.getElementById('taskTimerDisplay').style.display = 'none';
            document.getElementById('minimizedTaskTimer').style.display = 'none';
            document.getElementById('floatingMsg').style.display = 'none';
            clearInterval(taskTimerInterval);
            taskTimerInterval = null;
            currentTaskIndex = null;
            pinnedTaskIndex = null;
            isTimerMinimized = false;
            loadTasks();
        }

        function minimizeTaskTimer() {
            isTimerMinimized = true;
            document.getElementById('taskTimerDisplay').style.display = 'none';
            document.getElementById('minimizedTaskTimer').style.display = 'flex';
            updateFloatingMsg();
        }

        function maximizeTaskTimer() {
            isTimerMinimized = false;
            document.getElementById('taskTimerDisplay').style.display = 'block';
            document.getElementById('minimizedTaskTimer').style.display = 'none';
            updateFloatingMsg();
        }

        function updateFloatingMsg() {
            const msg = document.getElementById('floatingMsg');
            if ((taskTimerInterval || isTaskPaused) && !isTimerMinimized) {
                msg.style.display = 'block';
            } else {
                msg.style.display = 'none';
            }
        }

        function pauseTaskTimer() {
            if (taskTimerInterval) {
                clearInterval(taskTimerInterval);
                taskTimerInterval = null;
                isTaskPaused = true;
                document.getElementById('minPauseBtn').style.display = 'none';
                document.getElementById('minResumeBtn').style.display = 'inline';
            }
        }

        function resumeTaskTimer() {
            if (isTaskPaused) {
                startTaskInterval();
                isTaskPaused = false;
                document.getElementById('minPauseBtn').style.display = 'inline';
                document.getElementById('minResumeBtn').style.display = 'none';
            }
        }

        function cancelTaskTimer() {
            if (currentTaskIndex === null) return;
            logCurrentSession();
            closeCompletionModal();
        }

        function addMoreTimeDuringRun() {
            const extra = parseInt(prompt('Add how many minutes?', '5'));
            if (extra && extra > 0) {
                taskTimeRemaining += extra * 60;
                taskOriginalDuration += extra * 60;
                updateTaskTimerDisplay();
            }
        }

        // Initialize page
        window.onload = () => {
            loadQuote();
            loadTasks();
            loadTodaysMood();
            updateTimerDisplay();
            loadNotes();
        };
    </script>
</body>
</html>