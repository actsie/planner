<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Calm - Your Gentle Digital Planner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #faf8f3;
            color: #4a5568;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            flex: 1;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
        }

        h1 {
            color: #7c9885;
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
        }

        .quote {
            font-style: italic;
            color: #718096;
            font-size: 1.1rem;
            margin-top: 1rem;
            min-height: 2rem;
        }

        .date-strip-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            margin-bottom: 1rem;
        }

        .month-label {
            cursor: pointer;
            user-select: none;
            font-weight: 500;
        }

        .date-strip {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding: 0.25rem 0;
        }

        .date-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            cursor: pointer;
            min-width: 40px;
            font-size: 0.75rem;
        }

        .date-item.today {
            background: #f0f4f3;
            box-shadow: 0 0 4px rgba(0,0,0,0.1);
        }

        .log-icon {
            font-size: 0.7rem;
        }

        .month-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 0.5rem;
            z-index: 10;
            display: none;
        }

        .month-dropdown.active {
            display: block;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
        }

        .month-day {
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            padding: 0.25rem;
            font-size: 0.75rem;
        }

        .month-day.today {
            background: #f0f4f3;
        }

        .main-content {
            display: grid;
            gap: 2rem;
            grid-template-columns: 1fr 1fr;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .card h2 {
            color: #7c9885;
            font-size: 1.3rem;
            font-weight: 400;
            margin-bottom: 1rem;
        }

        /* To-Do List Styles */
        .todo-input-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        #taskInput {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e8dfd6;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        #taskInput::placeholder {
            color: #B0B0B0;
        }

        #taskInput:focus {
            outline: none;
            border-color: #b5a99f;
        }

        #addTask {
            background: #b5a99f;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }

        #addTask:hover {
            background: #9f8e82;
        }

        #taskList {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .task {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #f5f5f5;
            transition: background 0.2s;
            position: relative;
        }

        .task.active-task {
            flex-direction: column;
            align-items: flex-start;
            background: #DDEDE2;
            border-left: 4px solid #B5CDBA;
            box-shadow: 0 0 6px rgba(180, 200, 170, 0.4);
        }

        .task.tagged-task {
            flex-direction: column;
            align-items: flex-start;
        }

        .task:hover {
            background: #faf8f3;
        }

        .task input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 0.75rem;
            cursor: pointer;
        }

        .task span {
            flex: 1;
            font-size: 0.95rem;
        }

        .task.completed span {
            text-decoration: line-through;
            color: #a0aec0;
        }

        .delete-task {
            background: none;
            border: none;
            color: #e2b1b1;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .timer-task {
            background: none;
            border: none;
            color: #7c9885;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .task:hover .delete-task,
        .task:hover .timer-task {
            opacity: 1;
        }

        .active-tag {
            background: #DDEDE2;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .worked-tag {
            background: #e8dfd6;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .task-tags {
            display: flex;
            gap: 6px;
            margin-bottom: 4px;
        }

        /* Mood Tracker Styles */
        .mood-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 1rem;
        }

        .emoji {
            font-size: 2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s;
            position: relative;
        }

        .emoji:hover {
            transform: scale(1.1);
            background: #f5f5f5;
        }

        .emoji.selected {
            background: #e8dfd6;
            transform: scale(1.15);
        }

        .mood-label {
            font-size: 0.75rem;
            text-align: center;
            margin-top: 0.25rem;
            color: #718096;
        }

        .mood-history {
            font-size: 0.9rem;
            color: #718096;
            margin-top: 1rem;
        }

        .mood-timeline {
            font-size: 0.75rem;
            color: #999;
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .mood-timeline-entry {
            margin-bottom: 0.25rem;
        }

        .mood-reason {
            margin-left: 1.2rem;
            font-style: italic;
            color: #555;
        }

        .edit-icon {
            cursor: pointer;
            margin-left: 4px;
            font-size: 0.8rem;
        }

        .link-button {
            background: none;
            border: none;
            padding: 0;
            color: #718096;
            cursor: pointer;
            font-size: 0.75rem;
        }

        /* Timer Styles */
        .timer-display {
            font-size: 3rem;
            text-align: center;
            color: #7c9885;
            margin: 1rem 0;
            font-weight: 300;
            font-variant-numeric: tabular-nums;
        }

        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .timer-btn {
            background: #c9b3a3;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }

        .timer-btn:hover {
            background: #b39b8b;
        }

        .timer-btn:disabled {
            background: #e2d8ce;
            cursor: not-allowed;
        }

        .timer-progress {
            width: 100%;
            height: 4px;
            background: #e8dfd6;
            border-radius: 2px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .timer-progress-bar {
            height: 100%;
            background: #7c9885;
            width: 0%;
            transition: width 1s linear;
        }

        /* Full width card for timer */
        .full-width {
            grid-column: 1 / -1;
        }

        /* Notes Section Styles */
        .notes-section {
            grid-column: 1 / -1;
            display: flex;
            gap: 1rem;
            min-height: 400px;
        }

        .notes-sidebar {
            flex: 0 0 250px;
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .notes-main {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
        }

        .notes-sidebar h3 {
            color: #7c9885;
            font-size: 1.1rem;
            font-weight: 400;
            margin-bottom: 1rem;
        }

        .add-note-btn {
            width: 100%;
            background: #c9b3a3;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
            margin-bottom: 1rem;
        }

        .add-note-btn:hover {
            background: #b39b8b;
        }

        .notes-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow-y: auto;
            max-height: 300px;
        }

        .note-item {
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            border: 2px solid transparent;
            position: relative;
        }

        .note-item:hover {
            background: #faf8f3;
        }

        .note-item.active {
            background: #e8dfd6;
            border-color: #c9b3a3;
        }

        .note-item-title {
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
        }

        .note-item-date {
            font-size: 0.75rem;
            color: #718096;
        }

        .delete-note {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            color: #e2b1b1;
            cursor: pointer;
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.2s;
            padding: 0.25rem;
        }

        .note-item:hover .delete-note {
            opacity: 1;
        }

        .note-editor {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .note-title-input {
            font-size: 1.5rem;
            color: #4a5568;
            border: none;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: transparent;
            font-weight: 500;
        }

        .note-title-input:focus {
            outline: none;
            background: #faf8f3;
            border-radius: 8px;
        }

        .note-content {
            flex: 1;
            border: 2px solid #e8dfd6;
            border-radius: 8px;
            padding: 1rem;
            font-size: 1rem;
            transition: border-color 0.2s;
            font-family: inherit;
            line-height: 1.6;
            min-height: 200px;
            overflow-y: auto;
        }

        .note-content:empty:before {
            content: attr(data-placeholder);
            color: #a0aec0;
        }

        .note-content:focus {
            outline: none;
            border-color: #b5a99f;
        }

        .format-toolbar {
            position: absolute;
            background: #f0f0f0;
            border-radius: 6px;
            padding: 0.25rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            gap: 0.25rem;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.15s ease;
        }

        .format-toolbar.show {
            opacity: 1;
        }

        .format-toolbar button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem 0.4rem;
            font-size: 0.9rem;
            color: #4a5568;
        }

        .empty-state {
            color: #718096;
            text-align: center;
            padding: 3rem;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .notes-section {
                flex-direction: column;
            }

            .notes-sidebar {
                flex: none;
            }

            .notes-list {
                max-height: 150px;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .modal h3 {
            color: #7c9885;
            margin-bottom: 1.5rem;
            font-weight: 400;
        }

        .duration-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .duration-btn {
            background: #e8dfd6;
            border: none;
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .duration-btn:hover {
            background: #c9b3a3;
            color: white;
        }

        .custom-duration {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .custom-duration input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e8dfd6;
            border-radius: 8px;
            font-size: 1rem;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }

        .modal-btn.primary {
            background: #c9b3a3;
            color: white;
        }

        .modal-btn.primary:hover {
            background: #b39b8b;
        }

        .modal-btn.secondary {
            background: #e8dfd6;
            color: #4a5568;
        }

        .modal-btn.secondary:hover {
            background: #d8cfc6;
        }

        /* Daily Log Panel */
        #dailyLogModal .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }
        .daily-log-day {
            margin-bottom: 1.5rem;
        }
        .daily-log-day h4 {
            color: #7c9885;
            font-weight: 400;
            margin-bottom: 0.5rem;
        }
        .daily-log-day ul {
            list-style: none;
            padding-left: 0;
            margin-bottom: 0.5rem;
        }
        .daily-log-day li {
            margin-bottom: 0.25rem;
        }
        .more-done {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #718096;
            cursor: pointer;
        }

        /* Task Timer Display */
        .task-timer-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            z-index: 999;
            min-width: 250px;
        }

        .minimize-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            color: #a0aec0;
        }

        .task-progress {
            width: 100%;
            height: 4px;
            background: #e8dfd6;
            border-radius: 2px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .task-progress-bar {
            height: 100%;
            background: #7c9885;
            width: 0%;
            transition: width 1s linear;
        }

        .minimized-task-timer {
            display: none;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .minimized-task-timer .controls button {
            background: none;
            border: none;
            cursor: pointer;
            margin-left: 0.25rem;
            color: #7c9885;
            font-size: 1rem;
        }

        .floating-msg {
            font-size: 0.85rem;
            color: #a0aec0;
            margin-bottom: 0.5rem;
        }

        .task-timer-title {
            color: #7c9885;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .task-timer-time {
            font-size: 2rem;
            color: #4a5568;
            font-weight: 300;
            font-variant-numeric: tabular-nums;
        }

        .task-header {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .task-info-icon {
            background: none;
            border: 1px solid #e8dfd6;
            color: #a0aec0;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            margin-left: 0.25rem;
            cursor: pointer;
        }

        .task-info-card {
            position: absolute;
            background: #f8f1e8;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            color: #4a5568;
            display: none;
            z-index: 1000;
        }

        .task-info-card::after {
            content: '';
            position: absolute;
            top: -6px;
            left: 10px;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid #f8f1e8;
        }

        .task-info-card .info-task-name {
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        /* Done List */
        .done-section {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e8dfd6;
        }

        .done-section h3 {
            color: #a0aec0;
            font-size: 1rem;
            font-weight: 400;
            margin-bottom: 0.5rem;
        }

        .done-task {
            opacity: 0.6;
        }

        .done-task span {
            text-decoration: line-through;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Daily Calm</h1>
            <p class="quote" id="quoteDisplay"></p>
        </header>

        <div class="date-strip-wrapper">
            <div id="monthLabel" class="month-label">Month ▾</div>
            <div id="dateStrip" class="date-strip"></div>
            <div id="monthDropdown" class="month-dropdown"></div>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>Today's Tasks <button id="openDailyLog" class="link-button">Logs</button></h2>
                <div class="todo-input-container">
                    <input type="text" id="taskInput" placeholder="What would you like to do today?" />
                    <button id="addTask">Add</button>
                </div>
                <ul id="taskList"></ul>
                <div id="taskInfoCard" class="task-info-card"></div>
            </div>

            <div class="card">
                <h2>How are you feeling?</h2>
                <div class="mood-container">
                    <div>
                        <div class="emoji" data-mood="😐">😐</div>
                        <div class="mood-label">meh</div>
                    </div>
                    <div>
                        <div class="emoji" data-mood="🙂">🙂</div>
                        <div class="mood-label">okay</div>
                    </div>
                    <div>
                        <div class="emoji" data-mood="😄">😄</div>
                        <div class="mood-label">good</div>
                    </div>
                    <div>
                        <div class="emoji" data-mood="😩">😩</div>
                        <div class="mood-label">tired</div>
                    </div>
                    <div>
                        <div class="emoji" data-mood="😠">😠</div>
                        <div class="mood-label">stressed</div>
                    </div>
                </div>
                <div class="mood-history" id="moodHistory"></div>
                <div class="mood-timeline" id="moodTimeline"></div>
                <button id="toggleMoodLog" class="link-button" style="display:none;">View all</button>
            </div>

            <div class="card full-width">
                <h2>Focus Timer</h2>
                <div id="floatingMsg" class="floating-msg" style="display:none;">Active timer is running elsewhere (see top-right)</div>
                <div id="minimizedTaskTimer" class="minimized-task-timer">
                    <div>
                        <span id="minTaskTitle"></span>
                        <span id="minTaskTime"></span>
                    </div>
                    <div class="controls">
                        <button onclick="pauseTaskTimer()" id="minPauseBtn">⏸️</button>
                        <button onclick="resumeTaskTimer()" id="minResumeBtn" style="display:none;">▶️</button>
                        <button onclick="cancelTaskTimer()">✖️</button>
                        <button onclick="addMoreTimeDuringRun()">➕</button>
                        <button onclick="maximizeTaskTimer()">🔼</button>
                    </div>
                    <div class="task-progress"><div class="task-progress-bar" id="minTaskProgressBar"></div></div>
                </div>
                <div class="timer-display" id="timerDisplay">25:00</div>
                <div class="timer-controls">
                    <button class="timer-btn" id="startTimer">Start</button>
                    <button class="timer-btn" id="pauseTimer" disabled>Pause</button>
                    <button class="timer-btn" id="resetTimer">Reset</button>
                </div>
                <div class="timer-progress">
                    <div class="timer-progress-bar" id="timerProgressBar"></div>
                </div>
            </div>

            <div class="notes-section">
                <div class="notes-sidebar">
                    <h3>My Notes</h3>
                    <button class="add-note-btn" id="addNoteBtn">+ Add Note</button>
                    <div class="notes-list" id="notesList"></div>
                </div>
                <div class="notes-main">
                    <div id="noteEditor" class="note-editor" style="display: none;">
                        <input type="text" class="note-title-input" id="noteTitleInput" placeholder="Note Title" />
                        <div class="note-content" id="noteContent" contenteditable="true" data-placeholder="Start writing your thoughts..."></div>
                        <div id="formatToolbar" class="format-toolbar" style="display:none;">
                            <button data-tag="strong">B</button>
                            <button data-tag="em">I</button>
                            <button data-tag="u">U</button>
                        </div>
                    </div>
                    <div id="emptyState" class="empty-state">
                        <p>Select a note to view or create a new one</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timer Duration Modal -->
    <div class="modal" id="durationModal">
        <div class="modal-content">
            <h3>Select Timer Duration</h3>
            <div class="duration-options">
                <button class="duration-btn" onclick="selectDuration(5)">5 minutes</button>
                <button class="duration-btn" onclick="selectDuration(10)">10 minutes</button>
                <button class="duration-btn" onclick="selectDuration(25)">25 minutes</button>
            </div>
            <div class="custom-duration">
                <input type="number" id="customDuration" placeholder="Custom minutes" min="1" max="60">
                <button class="modal-btn primary" onclick="selectCustomDuration()">Start</button>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeDurationModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Task Completion Modal -->
    <div class="modal" id="completionModal">
        <div class="modal-content">
            <h3>Timer Complete! Did you finish this task?</h3>
            <div class="modal-actions">
                <button class="modal-btn primary" onclick="completeTask()">✅ Yes</button>
                <button class="modal-btn secondary" onclick="addMoreTime()">➕ Add more time</button>
                <button class="modal-btn secondary" onclick="keepTaskActive()">🕗 Not yet</button>
            </div>
        </div>
    </div>

    <!-- Daily Log Modal -->
    <div class="modal" id="dailyLogModal">
        <div class="modal-content">
            <h3>Daily Log</h3>
            <div id="dailyLogContent"></div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeDailyLog()">Close</button>
            </div>
        </div>
    </div>

    <!-- Task Timer Display -->
    <div class="task-timer-display" id="taskTimerDisplay" style="display: none;">
        <button class="minimize-btn" onclick="minimizeTaskTimer()">▾</button>
        <div class="task-timer-title" id="taskTimerTitle"></div>
        <div class="task-timer-time" id="taskTimerTime"></div>
        <div class="task-progress"><div class="task-progress-bar" id="taskProgressBar"></div></div>
    </div>

    <script>
        // Encouraging quotes
        const quotes = [
            "You don't have to finish, just begin.",
            "Progress, not perfection.",
            "One small step is still a step forward.",
            "You're doing better than you think.",
            "Be gentle with yourself today.",
            "It's okay to rest when you need to.",
            "You are enough, just as you are.",
            "Breathe. You've got this.",
            "Small wins are still wins.",
            "Your pace is perfect for you.",
            "Every moment is a fresh start.",
            "You're allowed to take your time."
        ];

        // Load and display random quote
        function loadQuote() {
            const quoteDisplay = document.getElementById('quoteDisplay');
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            quoteDisplay.textContent = randomQuote;
        }

        // To-Do List functionality
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        const taskList = document.getElementById('taskList');
        const taskInput = document.getElementById('taskInput');
        const addTaskButton = document.getElementById('addTask');
        const openDailyLogBtn = document.getElementById('openDailyLog');

        // Task Timer variables
        let currentTaskIndex = null;
        let taskTimerInterval = null;
        let taskTimeRemaining = 0;
        let selectedDuration = 0;
        let taskOriginalDuration = 0;
        let isTaskPaused = false;
        let isTimerMinimized = false;
        let pinnedTaskIndex = null;
        let pendingMoodType = null;
        let halfwayPrompted = false;

        const monthLabelEl = document.getElementById('monthLabel');
        const dateStripEl = document.getElementById('dateStrip');
        const monthDropdownEl = document.getElementById('monthDropdown');

        function isDateToday(dateStr) {
            if (!dateStr) return false;
            const d = new Date(dateStr);
            const today = new Date();
            return d.getFullYear() === today.getFullYear() &&
                   d.getMonth() === today.getMonth() &&
                   d.getDate() === today.getDate();
        }

        function checkForNewDay() {
            const todayStr = new Date().toISOString().split('T')[0];
            const last = localStorage.getItem('lastLogDate');
            if (last && last !== todayStr) {
                const dailyLog = JSON.parse(localStorage.getItem('dailyLog')) || [];
                const moodLog = JSON.parse(localStorage.getItem('moodLog')) || [];
                const storedTasks = JSON.parse(localStorage.getItem('tasks')) || [];
                const completed = storedTasks.filter(t => t.completed && t.completedAt && t.completedAt.startsWith(last));
                if (completed.length || moodLog.length) {
                    dailyLog.push({ date: last, tasks: completed, moods: moodLog });
                }
                const remaining = storedTasks.filter(t => !(t.completed && t.completedAt && t.completedAt.startsWith(last)));
                localStorage.setItem('tasks', JSON.stringify(remaining));
                localStorage.removeItem('moodLog');
                localStorage.setItem('dailyLog', JSON.stringify(dailyLog));
                tasks = remaining;
            }
            localStorage.setItem('lastLogDate', todayStr);
        }

        function hasLog(dateStr) {
            const past = JSON.parse(localStorage.getItem('dailyLog')) || [];
            if (isDateToday(dateStr)) {
                const tasksToday = tasks.filter(t => t.completed && isDateToday(t.completedAt));
                const moodsToday = JSON.parse(localStorage.getItem('moodLog')) || [];
                return tasksToday.length || moodsToday.length;
            }
            const entry = past.find(e => e.date === dateStr);
            return entry && (entry.tasks.length || entry.moods.length);
        }

        function renderDateStrip() {
            const today = new Date();
            const start = new Date(today);
            start.setDate(today.getDate() - 3);
            dateStripEl.innerHTML = '';
            for (let i = 0; i < 7; i++) {
                const d = new Date(start);
                d.setDate(start.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                const item = document.createElement('div');
                item.classList.add('date-item');
                if (isDateToday(dateStr)) item.classList.add('today');
                item.innerHTML = `<div>${d.toLocaleDateString(undefined,{weekday:'short'})}</div><div>${d.getDate()}</div>`;
                if (hasLog(dateStr)) {
                    const icon = document.createElement('span');
                    icon.textContent = '📘';
                    icon.classList.add('log-icon');
                    item.appendChild(icon);
                }
                item.addEventListener('click', () => openDailyLog(dateStr));
                dateStripEl.appendChild(item);
            }
            monthLabelEl.textContent = today.toLocaleDateString(undefined,{month:'long'}) + ' ▾';
        }

        function toggleMonthDropdown() {
            monthDropdownEl.classList.toggle('active');
            if (monthDropdownEl.classList.contains('active')) {
                renderMonthGrid();
            }
        }

        function renderMonthGrid() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const first = new Date(year, month, 1);
            const last = new Date(year, month + 1, 0);
            monthDropdownEl.innerHTML = '';
            const grid = document.createElement('div');
            grid.className = 'month-grid';
            for (let i = 1; i <= last.getDate(); i++) {
                const d = new Date(year, month, i);
                const dateStr = d.toISOString().split('T')[0];
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('month-day');
                if (isDateToday(dateStr)) dayDiv.classList.add('today');
                dayDiv.textContent = i;
                if (hasLog(dateStr)) {
                    dayDiv.innerHTML = `<span>${i}</span><span class='log-icon'>📘</span>`;
                }
                dayDiv.addEventListener('click', () => { openDailyLog(dateStr); monthDropdownEl.classList.remove('active'); });
                grid.appendChild(dayDiv);
            }
            monthDropdownEl.appendChild(grid);
        }

        function openDailyLog(dateStr) {
            loadDailyLog(dateStr);
            document.getElementById('dailyLogModal').classList.add('active');
        }

        function closeDailyLog() {
            document.getElementById('dailyLogModal').classList.remove('active');
        }

        function loadDailyLog(dateStr) {
            const container = document.getElementById('dailyLogContent');
            container.innerHTML = '';
            const todayStr = new Date().toISOString().split('T')[0];
            const tasksToday = tasks.filter(t => t.completed && isDateToday(t.completedAt));
            const moodsToday = JSON.parse(localStorage.getItem('moodLog')) || [];
            const past = JSON.parse(localStorage.getItem('dailyLog')) || [];
            const log = [];

            if (dateStr) {
                if (dateStr === todayStr) {
                    log.push({ date: todayStr, tasks: tasksToday, moods: moodsToday });
                } else {
                    const entry = past.find(e => e.date === dateStr);
                    log.push(entry || { date: dateStr, tasks: [], moods: [] });
                }
            } else {
                log.push({ date: todayStr, tasks: tasksToday, moods: moodsToday });
                past.sort((a,b) => new Date(b.date) - new Date(a.date));
                log.push(...past);
            }

            log.forEach(entry => {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('daily-log-day');
                const dateHeader = document.createElement('h4');
                dateHeader.textContent = new Date(entry.date).toLocaleDateString(undefined, { month: 'long', day: 'numeric', year: 'numeric' });
                dayDiv.appendChild(dateHeader);

                if (!entry.tasks.length && !entry.moods.length) {
                    const p = document.createElement('p');
                    p.textContent = "No tasks completed. That's okay. Rest counts too. 🌱";
                    dayDiv.appendChild(p);
                } else {
                    if (entry.tasks.length) {
                        entry.tasks.forEach((t) => {
                            const taskDiv = document.createElement('div');
                            const mins = t.totalTime ? Math.round(t.totalTime / 60) : 0;
                            const sessions = (t.sessions ? t.sessions.length : 0);
                            taskDiv.innerHTML = `<strong>📝 Task: ${t.task}</strong><br>⏳ Total time: ${mins} mins<br>🧠 Pomodoro sessions: ${sessions}`;

                            const taskMoods = entry.moods.filter(m => m.task === t.task);
                            if (taskMoods.length) {
                                const moodHeader = document.createElement('div');
                                moodHeader.innerHTML = '<em>😊 Moods:</em>';
                                taskDiv.appendChild(moodHeader);
                                const ul = document.createElement('ul');
                                taskMoods.forEach((m) => {
                                    const li = document.createElement('li');
                                    const time = new Date(m.date).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                                    const labelMap = { before: '💡 Before', midway: '⏳ Midway', after: '✅ After' };
                                    const minsInto = (m.minutesIntoTask !== undefined && m.minutesIntoTask !== null) ? ` (${m.minutesIntoTask} min)` : '';
                                    li.innerHTML = `${labelMap[m.type] || ''}: ${m.mood} ${time}${minsInto}`;
                                    if (m.reason) {
                                        const reasonDiv = document.createElement('div');
                                        reasonDiv.className = 'mood-reason';
                                        reasonDiv.textContent = `"${m.reason}"`;
                                        li.appendChild(reasonDiv);
                                    }
                                    if (['😐','😩','😠'].includes(m.mood)) {
                                        const edit = document.createElement('span');
                                        edit.textContent = '🖊️';
                                        edit.classList.add('edit-icon');
                                        edit.dataset.day = entry.date;
                                        edit.dataset.index = entry.moods.indexOf(m);
                                        edit.addEventListener('click', () => editMoodReason(edit.dataset.day, edit.dataset.index));
                                        li.appendChild(edit);
                                    }
                                    ul.appendChild(li);
                                });
                                taskDiv.appendChild(ul);
                            }

                            dayDiv.appendChild(taskDiv);
                        });
                    }

                    const generalMoods = entry.moods.filter(m => !m.task);
                    if (generalMoods.length) {
                        const h = document.createElement('div');
                        h.innerHTML = '<strong>Mood Entries:</strong>';
                        dayDiv.appendChild(h);
                        const ul = document.createElement('ul');
                        generalMoods.forEach(m => {
                            const li = document.createElement('li');
                            const time = new Date(m.date).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                            const labelMap = { before: '💡 Before', midway: '⏳ Midway', after: '✅ After' };
                            const minsInto = (m.minutesIntoTask !== undefined && m.minutesIntoTask !== null) ? ` (${m.minutesIntoTask} min)` : '';
                            li.innerHTML = `${labelMap[m.type] || ''}: ${m.mood} ${time}${minsInto}`;
                            if (m.reason) {
                                const reasonDiv = document.createElement('div');
                                reasonDiv.className = 'mood-reason';
                                reasonDiv.textContent = `"${m.reason}"`;
                                li.appendChild(reasonDiv);
                            }
                            if (['😐','😩','😠'].includes(m.mood)) {
                                const edit = document.createElement('span');
                                edit.textContent = '🖊️';
                                edit.classList.add('edit-icon');
                                edit.dataset.day = entry.date;
                                edit.dataset.index = entry.moods.indexOf(m);
                                edit.addEventListener('click', () => editMoodReason(edit.dataset.day, edit.dataset.index));
                                li.appendChild(edit);
                            }
                            ul.appendChild(li);
                        });
                        dayDiv.appendChild(ul);
                    }
                }

            container.appendChild(dayDiv);
        });
    }

    function editMoodReason(day, index) {
        const todayStr = new Date().toISOString().split('T')[0];
        if (day === todayStr) {
            let moodLog = JSON.parse(localStorage.getItem('moodLog')) || [];
            const entry = moodLog[index];
            const reason = prompt('Update reason', entry.reason || '');
            if (reason !== null) {
                moodLog[index].reason = reason;
                localStorage.setItem('moodLog', JSON.stringify(moodLog));
                loadDailyLog(day);
            }
        } else {
            let dailyLog = JSON.parse(localStorage.getItem('dailyLog')) || [];
            const logEntry = dailyLog.find(e => e.date === day);
            if (!logEntry) return;
            const entry = logEntry.moods[index];
            const reason = prompt('Update reason', entry.reason || '');
            if (reason !== null) {
                logEntry.moods[index].reason = reason;
                localStorage.setItem('dailyLog', JSON.stringify(dailyLog));
                loadDailyLog(day);
            }
        }
    }

        function loadTasks() {
            taskList.innerHTML = '';

            let activeIndices = tasks.map((t, i) => i).filter(i => !tasks[i].completed);
            if (pinnedTaskIndex !== null && activeIndices.includes(pinnedTaskIndex)) {
                activeIndices = [pinnedTaskIndex, ...activeIndices.filter(i => i !== pinnedTaskIndex)];
            }

            activeIndices.forEach(idx => {
                const task = tasks[idx];
                const li = document.createElement('li');
                li.classList.add('task');

                const isActive = idx === pinnedTaskIndex && (taskTimerInterval || isTaskPaused);
                if (isActive) li.classList.add('active-task');

                const workedMinutes = task.totalTime ? Math.round(task.totalTime / 60) : 0;
                const showInfo = task.totalTime || (task.sessions && task.sessions.length);
                const infoIcon = showInfo ? `<button class='task-info-icon' onclick='showTaskInfo(event, ${idx})'>i</button>` : '';
                const activeTag = isActive ? `<div class='active-tag' title='Active' aria-label='Active'>⏱ Active</div>` : '';
                const timeTag = workedMinutes ? `<div class='worked-tag' title='Worked ${workedMinutes} min' aria-label='Worked ${workedMinutes} min'>${task.completed ? '⌛️' : '🚧'} ${workedMinutes} min</div>` : '';
                const tagsBlock = activeTag || timeTag ? `<div class='task-tags'>${activeTag}${timeTag}</div>` : '';
                if (tagsBlock) li.classList.add('tagged-task');

                li.innerHTML = `
                    ${tagsBlock}
                    <div class='task-header'>
                        <input type='checkbox' ${task.completed ? 'checked' : ''} onchange='toggleTask(${idx})'/>
                        <span>${task.task}</span>${infoIcon}
                        <button class='timer-task' onclick='startTaskTimer(${idx})'>⏱️</button>
                        <button class='delete-task' onclick='deleteTask(${idx})'>×</button>
                    </div>
                `;

                taskList.appendChild(li);
            });
            
            // Done tasks
            const doneTasks = tasks.filter(task => task.completed && isDateToday(task.completedAt));
            if (doneTasks.length > 0) {
                const doneSection = document.createElement('div');
                doneSection.classList.add('done-section');
                doneSection.innerHTML = '<h3>Done</h3>';
                doneTasks.slice(0,2).forEach((task, index) => {
                    const actualIndex = tasks.indexOf(task);
                    const li = document.createElement('li');
                    li.classList.add('task', 'done-task');

                    const workedMinutes = task.totalTime ? Math.round(task.totalTime / 60) : 0;
                    const showInfo = task.totalTime || (task.sessions && task.sessions.length);
                    const infoIcon = showInfo ? `<button class='task-info-icon' onclick='showTaskInfo(event, ${actualIndex})'>i</button>` : '';
                    const timeTag = workedMinutes ? `<div class='worked-tag' title='Worked ${workedMinutes} min' aria-label='Worked ${workedMinutes} min'>⌛️ ${workedMinutes} min</div>` : '';
                    const tagsBlock = timeTag ? `<div class='task-tags'>${timeTag}</div>` : '';
                    if (tagsBlock) li.classList.add('tagged-task');
                    li.innerHTML = `
                        ${tagsBlock}
                        <div class='task-header'>
                            <input type='checkbox' ${task.completed ? 'checked' : ''} onchange='toggleTask(${actualIndex})'/>
                            <span>${task.task}</span>${infoIcon}
                            <button class='delete-task' onclick='deleteTask(${actualIndex})'>×</button>
                        </div>
                    `;
                    doneSection.appendChild(li);
                });

                if (doneTasks.length > 2) {
                    const more = document.createElement('div');
                    more.classList.add('more-done');
                    more.textContent = `+ ${doneTasks.length - 2} more in Log`;
                    more.addEventListener('click', openDailyLog);
                    doneSection.appendChild(more);
                }

                taskList.appendChild(doneSection);
            }
        }

        function renderTaskInfoCard(index) {
            const card = document.getElementById('taskInfoCard');
            const task = tasks[index];
            const total = Math.round((task.totalTime || 0) / 60);

            const sessions = task.sessions || [];
            const today = new Date();
            const sessionsToday = sessions.filter(s => {
                const d = new Date(s.completedAt);
                return d.getFullYear() === today.getFullYear() &&
                       d.getMonth() === today.getMonth() &&
                       d.getDate() === today.getDate();
            }).length;

            let lastTime = null;
            if (sessions.length) {
                const last = sessions[sessions.length - 1];
                lastTime = new Date(last.completedAt).toLocaleString([], { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
            }

            card.innerHTML = `
                <div class='info-task-name'>${task.task}</div>
                <div>Worked: ${total} min</div>
                <div>🧠 Sessions today: ${sessionsToday}</div>
                ${lastTime ? `<div>Last session: ${lastTime}</div>` : ''}
                <div>${task.completed ? 'Completed' : 'Not done yet'}</div>
            `;
            card.dataset.index = index;
        }

        function showTaskInfo(event, index) {
            event.stopPropagation();
            const card = document.getElementById('taskInfoCard');
            renderTaskInfoCard(index);
            card.style.display = 'block';
            card.style.top = (event.target.getBoundingClientRect().bottom + window.scrollY + 6) + 'px';
            card.style.left = (event.target.getBoundingClientRect().left + window.scrollX) + 'px';
        }

        document.addEventListener('click', function(e) {
            const card = document.getElementById('taskInfoCard');
            if (card.style.display === 'block' && !card.contains(e.target)) {
                card.style.display = 'none';
            }
        });

        window.addEventListener('scroll', () => {
            document.getElementById('taskInfoCard').style.display = 'none';
        });

        function addTask() {
            const taskValue = taskInput.value.trim();
            if (taskValue) {
                tasks.push({ 
                    task: taskValue, 
                    completed: false,
                    totalTime: 0,
                    sessions: []
                });
                localStorage.setItem('tasks', JSON.stringify(tasks));
                taskInput.value = '';
                loadTasks();
            }
        }

        function toggleTask(index) {
            tasks[index].completed = !tasks[index].completed;
            if (tasks[index].completed) {
                tasks[index].completedAt = new Date().toISOString();
            } else {
                delete tasks[index].completedAt;
            }
            localStorage.setItem('tasks', JSON.stringify(tasks));
            loadTasks();
        }

        function deleteTask(index) {
            tasks.splice(index, 1);
            localStorage.setItem('tasks', JSON.stringify(tasks));
            loadTasks();
        }

        // Add task on Enter key
        taskInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTask();
            }
        });

        addTaskButton.addEventListener('click', addTask);

        // Mood Tracker functionality
        const moodEmojis = document.querySelectorAll('.emoji');
        const moodHistory = document.getElementById('moodHistory');
        const moodTimeline = document.getElementById('moodTimeline');
        const toggleMoodLogBtn = document.getElementById('toggleMoodLog');
        let showAllMoodLog = false;

        function loadTodaysMood() {
            const moodLog = JSON.parse(localStorage.getItem('moodLog')) || [];

            if (moodLog.length) {
                const last = moodLog[moodLog.length - 1];
                moodEmojis.forEach(emoji => {
                    if (emoji.dataset.mood === last.mood) {
                        emoji.classList.add('selected');
                    }
                });
            }

            updateMoodHistory();
        }

        function formatTime(dateStr) {
            const options = { hour: 'numeric', minute: 'numeric' };
            return new Date(dateStr).toLocaleTimeString([], options);
        }

        function updateMoodHistory() {
            const moodLog = JSON.parse(localStorage.getItem('moodLog')) || [];

            moodTimeline.innerHTML = '';

            if (moodLog.length === 0) {
                moodHistory.textContent = 'No mood logged yet';
                toggleMoodLogBtn.style.display = 'none';
                return;
            }

            const last = moodLog[moodLog.length - 1];
            const lastTime = new Date(last.date).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' });
            const lastElapsed = (last.minutesIntoTask !== null && last.minutesIntoTask !== undefined) ? last.minutesIntoTask : last.elapsed;
            const taskInfoLast = last.task ? `During "${last.task}" (${lastElapsed} min in)` : 'No task active';
            moodHistory.textContent = `Latest mood: ${last.mood} – ${lastTime} – ${taskInfoLast}`;

            const entries = showAllMoodLog ? moodLog.slice() : moodLog.slice(-7);

            entries.reverse().forEach(entry => {
                const div = document.createElement('div');
                div.classList.add('mood-timeline-entry');
                const eElapsed = (entry.minutesIntoTask !== null && entry.minutesIntoTask !== undefined) ? entry.minutesIntoTask : entry.elapsed;
                const taskInfo = entry.task ? `During "${entry.task}" (${eElapsed} min in)` : 'No task active';
                div.textContent = `${entry.mood} – ${formatTime(entry.date)} – ${taskInfo}`;
                moodTimeline.appendChild(div);
            });

            toggleMoodLogBtn.style.display = moodLog.length > 7 ? 'inline' : 'none';
            toggleMoodLogBtn.textContent = showAllMoodLog ? 'Hide' : 'View all';
        }

        moodEmojis.forEach(emoji => {
            emoji.addEventListener('click', function() {
                moodEmojis.forEach(e => e.classList.remove('selected'));
                this.classList.add('selected');

                const now = new Date();
                let moodLog = JSON.parse(localStorage.getItem('moodLog')) || [];

                let taskName = null;
                let minutesIntoTask = null;
                if (taskTimerInterval && currentTaskIndex !== null) {
                    const task = tasks[currentTaskIndex];
                    if (task) {
                        taskName = task.task;
                        minutesIntoTask = Math.floor((selectedDuration * 60 - taskTimeRemaining) / 60);
                    }
                }

                let moodType = pendingMoodType || ((taskTimerInterval || isTaskPaused) ? 'midway' : 'before');
                if (moodType === 'after') {
                    minutesIntoTask = Math.floor(taskOriginalDuration / 60);
                } else if (moodType === 'before') {
                    minutesIntoTask = 0;
                }

                let reason = null;
                if (['😐','😩','😠'].includes(this.dataset.mood)) {
                    reason = prompt('Want to add a reason?');
                }

                moodLog.push({
                    date: now.toISOString(),
                    mood: this.dataset.mood,
                    task: taskName,
                    minutesIntoTask: minutesIntoTask,
                    type: moodType,
                    reason: reason
                });

                localStorage.setItem('moodLog', JSON.stringify(moodLog));
                updateMoodHistory();
                pendingMoodType = null;
            });
        });

        toggleMoodLogBtn.addEventListener('click', () => {
            showAllMoodLog = !showAllMoodLog;
            updateMoodHistory();
        });

        // Timer functionality
        let timerInterval;
        let totalTime = 25 * 60; // default timer length in seconds
        let timeRemaining = totalTime;
        let isRunning = false;

        const timerDisplay = document.getElementById('timerDisplay');
        const startBtn = document.getElementById('startTimer');
        const pauseBtn = document.getElementById('pauseTimer');
        const resetBtn = document.getElementById('resetTimer');
        const progressBar = document.getElementById('timerProgressBar');

        // Allow editing timer duration when not running
        timerDisplay.addEventListener('click', () => {
            if (isRunning) return;
            const input = prompt('Set timer minutes:', Math.floor(totalTime / 60));
            if (input !== null) {
                const minutes = parseInt(input);
                if (!isNaN(minutes) && minutes > 0) {
                    totalTime = minutes * 60;
                    timeRemaining = totalTime;
                    progressBar.style.width = '0%';
                    updateTimerDisplay();
                }
            }
        });

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update progress bar
            const progress = ((totalTime - timeRemaining) / totalTime) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function startTimer() {
            if (!isRunning) {
                isRunning = true;
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                
                timerInterval = setInterval(() => {
                    if (timeRemaining > 0) {
                        timeRemaining--;
                        updateTimerDisplay();
                    } else {
                        // Timer finished
                        clearInterval(timerInterval);
                        isRunning = false;
                        startBtn.disabled = false;
                        pauseBtn.disabled = true;
                        alert('Time for a break! Great job focusing!');
                        resetTimer();
                    }
                }, 1000);
            }
        }

        function pauseTimer() {
            if (isRunning) {
                clearInterval(timerInterval);
                isRunning = false;
                startBtn.disabled = false;
                pauseBtn.disabled = true;
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            timeRemaining = totalTime;
            updateTimerDisplay();
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            progressBar.style.width = '0%';
        }

        startBtn.addEventListener('click', startTimer);
        pauseBtn.addEventListener('click', pauseTimer);
        resetBtn.addEventListener('click', resetTimer);

        // Notes functionality
        let notes = JSON.parse(localStorage.getItem('notes')) || [];
        let currentNoteId = null;
        let autoSaveTimeout = null;

        const notesList = document.getElementById('notesList');
        const noteEditor = document.getElementById('noteEditor');
        const emptyState = document.getElementById('emptyState');
        const noteTitleInput = document.getElementById('noteTitleInput');
        const noteContent = document.getElementById('noteContent');
        const addNoteBtn = document.getElementById('addNoteBtn');

        function generateNoteId() {
            return Date.now().toString();
        }

        function formatDate(date) {
            const options = { month: 'short', day: 'numeric', year: 'numeric' };
            return new Date(date).toLocaleDateString('en-US', options);
        }

        function loadNotes() {
            notesList.innerHTML = '';
            
            notes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            notes.forEach(note => {
                const noteItem = document.createElement('div');
                noteItem.classList.add('note-item');
                if (note.id === currentNoteId) {
                    noteItem.classList.add('active');
                }
                
                noteItem.innerHTML = `
                    <div class="note-item-title">${note.title || 'Untitled Note'}</div>
                    <div class="note-item-date">${formatDate(note.createdAt)}</div>
                    <button class="delete-note" onclick="event.stopPropagation(); deleteNote('${note.id}')">×</button>
                `;
                
                noteItem.onclick = () => selectNote(note.id);
                notesList.appendChild(noteItem);
            });
        }

        function selectNote(noteId) {
            currentNoteId = noteId;
            const note = notes.find(n => n.id === noteId);
            
            if (note) {
                noteTitleInput.value = note.title || '';
                noteContent.innerHTML = note.content || '';
                noteEditor.style.display = 'flex';
                emptyState.style.display = 'none';
                loadNotes();
            }
        }

        function createNote() {
            const newNote = {
                id: generateNoteId(),
                title: 'New Note',
                content: '',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            notes.push(newNote);
            localStorage.setItem('notes', JSON.stringify(notes));
            selectNote(newNote.id);
            loadNotes();
            noteTitleInput.focus();
            noteTitleInput.select();
        }

        function deleteNote(noteId) {
            if (confirm('Are you sure you want to delete this note?')) {
                notes = notes.filter(n => n.id !== noteId);
                localStorage.setItem('notes', JSON.stringify(notes));
                
                if (noteId === currentNoteId) {
                    currentNoteId = null;
                    noteEditor.style.display = 'none';
                    emptyState.style.display = 'block';
                }
                
                loadNotes();
            }
        }

        function autoSaveNote() {
            if (currentNoteId) {
                const note = notes.find(n => n.id === currentNoteId);
                if (note) {
                    note.title = noteTitleInput.value || 'Untitled Note';
                    note.content = noteContent.innerHTML;
                    note.updatedAt = new Date().toISOString();
                    localStorage.setItem('notes', JSON.stringify(notes));
                    loadNotes();
                }
            }
        }

        function handleNoteInput() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(autoSaveNote, 500);
        }

        // Add event listeners for notes
        addNoteBtn.addEventListener('click', createNote);
        noteTitleInput.addEventListener('input', handleNoteInput);
        noteContent.addEventListener('input', handleNoteInput);

        // Floating formatting toolbar
        const formatToolbar = document.getElementById('formatToolbar');

        function applyFormat(tag) {
            const commandMap = {
                strong: 'bold',
                em: 'italic',
                del: 'strikeThrough',
                u: 'underline'
            };

            const sel = window.getSelection();
            if (!sel.rangeCount) return;
            const range = sel.getRangeAt(0);
            if (range.collapsed || !noteContent.contains(sel.anchorNode)) return;

            if (tag === 'mark') {
                if (isSelectionFullyWrapped(range, 'mark')) {
                    document.execCommand('hiliteColor', false, 'transparent');
                } else {
                    document.execCommand('hiliteColor', false, 'yellow');
                }
            } else if (tag === 'del') {
                document.execCommand('strikeThrough');
            } else {
                document.execCommand(commandMap[tag]);
            }
            normalizeFormatting();

            hideFormatToolbar();
            autoSaveNote();
        }

        function normalizeFormatting() {
            noteContent.querySelectorAll('b').forEach(el => {
                const strong = document.createElement('strong');
                strong.innerHTML = el.innerHTML;
                el.replaceWith(strong);
            });
            noteContent.querySelectorAll('i').forEach(el => {
                const em = document.createElement('em');
                em.innerHTML = el.innerHTML;
                el.replaceWith(em);
            });
            noteContent.querySelectorAll('strike').forEach(el => {
                const del = document.createElement('del');
                del.innerHTML = el.innerHTML;
                el.replaceWith(del);
            });
            noteContent.querySelectorAll('span[style*="background"]').forEach(el => {
                const bg = el.style.backgroundColor;
                if (bg === 'yellow' || bg === 'rgb(255, 255, 0)') {
                    const mark = document.createElement('mark');
                    mark.innerHTML = el.innerHTML;
                    el.replaceWith(mark);
                } else if (bg === 'transparent' || bg === '') {
                    while (el.firstChild) {
                        el.parentNode.insertBefore(el.firstChild, el);
                    }
                    el.remove();
                }
            });
        }

        function isSelectionFullyWrapped(range, tag) {
            const frag = range.cloneContents();
            const walker = document.createTreeWalker(frag, NodeFilter.SHOW_TEXT, null);
            while (walker.nextNode()) {
                const node = walker.currentNode;
                if (node.nodeValue.trim() === '') continue;
                let parent = node.parentNode;
                let inside = false;
                while (parent) {
                    if (parent.nodeType === 1 && parent.tagName.toLowerCase() === tag) {
                        inside = true;
                        break;
                    }
                    parent = parent.parentNode;
                }
                if (!inside) return false;
            }
            return true;
        }




        function positionToolbar() {
            const sel = window.getSelection();
            if (!sel.rangeCount || sel.isCollapsed || !noteContent.contains(sel.anchorNode)) {
                hideFormatToolbar();
                return;
            }
            const range = sel.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            formatToolbar.style.display = 'flex';
            const toolbarRect = formatToolbar.getBoundingClientRect();
            const top = rect.top + window.scrollY - toolbarRect.height - 6;
            const left = rect.left + window.scrollX + (rect.width - toolbarRect.width) / 2;
            formatToolbar.style.top = `${top}px`;
            formatToolbar.style.left = `${left}px`;
            requestAnimationFrame(() => formatToolbar.classList.add('show'));
        }

        function hideFormatToolbar() {
            formatToolbar.classList.remove('show');
            formatToolbar.style.display = 'none';
        }

        formatToolbar.addEventListener('mousedown', e => {
            e.preventDefault();
        });

        formatToolbar.addEventListener('click', e => {
            const tag = e.target.getAttribute('data-tag');
            if (tag) {
                applyFormat(tag);
            }
        });

        noteContent.addEventListener('mouseup', positionToolbar);
        noteContent.addEventListener('keyup', positionToolbar);
        noteContent.addEventListener('blur', () => setTimeout(hideFormatToolbar, 100));
        document.addEventListener('scroll', hideFormatToolbar);

        noteContent.addEventListener('keydown', function(e) {
            if ((e.metaKey || e.ctrlKey) && !e.shiftKey) {
                const key = e.key.toLowerCase();
                if (['b','i','s','u','h'].includes(key)) {
                    e.preventDefault();
                    const map = { b:'strong', i:'em', s:'del', u:'u', h:'mark' };
                    applyFormat(map[key]);
                }
            }
        });

        // Allow renaming by clicking on title
        noteTitleInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                noteContent.focus();
            }
        });

        // Task Timer Functions
        function startTaskTimer(index) {
            currentTaskIndex = index;
            document.getElementById('durationModal').classList.add('active');
        }

        function selectDuration(minutes) {
            selectedDuration = minutes;
            closeDurationModal();
            startTaskCountdown();
        }

        function selectCustomDuration() {
            const customInput = document.getElementById('customDuration');
            const minutes = parseInt(customInput.value);
            if (minutes && minutes > 0 && minutes <= 60) {
                selectedDuration = minutes;
                closeDurationModal();
                startTaskCountdown();
            }
        }

        function closeDurationModal() {
            document.getElementById('durationModal').classList.remove('active');
            document.getElementById('customDuration').value = '';
        }

        function startTaskCountdown() {
            if (currentTaskIndex === null) return;

            pendingMoodType = null;
            halfwayPrompted = false;

            const task = tasks[currentTaskIndex];
            taskOriginalDuration = selectedDuration * 60;
            taskTimeRemaining = taskOriginalDuration;
            isTaskPaused = false;
            isTimerMinimized = false;
            pinnedTaskIndex = currentTaskIndex;

            const display = document.getElementById('taskTimerDisplay');
            const titleEl = document.getElementById('taskTimerTitle');
            const timeEl = document.getElementById('taskTimerTime');

            display.style.display = 'block';
            document.getElementById('minimizedTaskTimer').style.display = 'none';
            titleEl.textContent = task.task;
            document.getElementById('minTaskTitle').textContent = task.task;

            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }

            startTaskInterval();
            updateTaskTimerDisplay();
            updateFloatingMsg();
            loadTasks();
        }

        function startTaskInterval() {
            clearInterval(taskTimerInterval);
            taskTimerInterval = setInterval(() => {
                if (taskTimeRemaining > 0) {
                    taskTimeRemaining--;
                    if (!halfwayPrompted && taskTimeRemaining <= taskOriginalDuration / 2) {
                        halfwayPrompted = true;
                        alert('Halfway there! How are you feeling? Select a mood.');
                        pendingMoodType = 'midway';
                    }
                    updateTaskTimerDisplay();
                } else {
                    clearInterval(taskTimerInterval);
                    taskTimerInterval = null;
                    taskTimerComplete();
                }
            }, 1000);
        }

        function updateTaskTimerDisplay() {
            const minutes = Math.floor(taskTimeRemaining / 60);
            const seconds = taskTimeRemaining % 60;
            document.getElementById('taskTimerTime').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('minTaskTime').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            const progress = ((taskOriginalDuration - taskTimeRemaining) / taskOriginalDuration) * 100;
            document.getElementById('taskProgressBar').style.width = `${progress}%`;
            document.getElementById('minTaskProgressBar').style.width = `${progress}%`;
        }

        function taskTimerComplete() {
            // Show notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Timer Complete!', {
                    body: `Time's up for: ${tasks[currentTaskIndex].task}`,
                    icon: '⏱️'
                });
            }
            
            // Play a gentle sound (optional)
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGG2S48+OZURE');
            audio.volume = 0.3;
            audio.play().catch(() => {});

            pendingMoodType = 'after';
            alert('How did that feel? Select a mood.');

            pinnedTaskIndex = null;
            document.getElementById('completionModal').classList.add('active');
            loadTasks();
        }

        function logCurrentSession() {
            if (currentTaskIndex === null) return;
            const elapsed = taskOriginalDuration - taskTimeRemaining;
            if (elapsed <= 0) return;
            tasks[currentTaskIndex].totalTime = (tasks[currentTaskIndex].totalTime || 0) + elapsed;
            tasks[currentTaskIndex].sessions = tasks[currentTaskIndex].sessions || [];
            tasks[currentTaskIndex].sessions.push({
                duration: elapsed / 60,
                completedAt: new Date().toISOString()
            });
            localStorage.setItem('tasks', JSON.stringify(tasks));

            const card = document.getElementById('taskInfoCard');
            if (card.style.display === 'block' && parseInt(card.dataset.index) === currentTaskIndex) {
                renderTaskInfoCard(currentTaskIndex);
            }
        }

        function completeTask() {
            if (currentTaskIndex === null) return;
            logCurrentSession();
            tasks[currentTaskIndex].completed = true;
            tasks[currentTaskIndex].completedAt = new Date().toISOString();
            localStorage.setItem('tasks', JSON.stringify(tasks));
            closeCompletionModal();
        }

        function addMoreTime() {
            logCurrentSession();
            document.getElementById('completionModal').classList.remove('active');
            document.getElementById('durationModal').classList.add('active');
        }

        function keepTaskActive() {
            if (currentTaskIndex === null) return;
            logCurrentSession();
            closeCompletionModal();
        }

        function closeCompletionModal() {
            document.getElementById('completionModal').classList.remove('active');
            document.getElementById('taskTimerDisplay').style.display = 'none';
            document.getElementById('minimizedTaskTimer').style.display = 'none';
            document.getElementById('floatingMsg').style.display = 'none';
            clearInterval(taskTimerInterval);
            taskTimerInterval = null;
            currentTaskIndex = null;
            pinnedTaskIndex = null;
            isTimerMinimized = false;
            loadTasks();
            updateFocusTimerVisibility();
        }

        function minimizeTaskTimer() {
            isTimerMinimized = true;
            document.getElementById('taskTimerDisplay').style.display = 'none';
            document.getElementById('minimizedTaskTimer').style.display = 'flex';
            updateFloatingMsg();
        }

        function maximizeTaskTimer() {
            isTimerMinimized = false;
            document.getElementById('taskTimerDisplay').style.display = 'block';
            document.getElementById('minimizedTaskTimer').style.display = 'none';
            updateFloatingMsg();
        }

       function updateFloatingMsg() {
           const msg = document.getElementById('floatingMsg');
           if ((taskTimerInterval || isTaskPaused) && !isTimerMinimized) {
               msg.style.display = 'block';
           } else {
               msg.style.display = 'none';
           }
            updateFocusTimerVisibility();
       }

        function updateFocusTimerVisibility() {
            const focusDisplay = document.getElementById('timerDisplay');
            const focusControls = document.querySelector('.timer-controls');
            const focusProgress = document.querySelector('.timer-progress');
            if (taskTimerInterval || isTaskPaused) {
                focusDisplay.style.display = 'none';
                focusControls.style.display = 'none';
                focusProgress.style.display = 'none';
            } else {
                focusDisplay.style.display = 'block';
                focusControls.style.display = 'flex';
                focusProgress.style.display = 'block';
            }
        }

       function pauseTaskTimer() {
           if (taskTimerInterval) {
               clearInterval(taskTimerInterval);
               taskTimerInterval = null;
               isTaskPaused = true;
               document.getElementById('minPauseBtn').style.display = 'none';
               document.getElementById('minResumeBtn').style.display = 'inline';
                updateFloatingMsg();
           }
       }

       function resumeTaskTimer() {
           if (isTaskPaused) {
               startTaskInterval();
               isTaskPaused = false;
               document.getElementById('minPauseBtn').style.display = 'inline';
               document.getElementById('minResumeBtn').style.display = 'none';
                updateFloatingMsg();
           }
       }

        function cancelTaskTimer() {
            if (currentTaskIndex === null) return;
            logCurrentSession();
            closeCompletionModal();
        }

        function addMoreTimeDuringRun() {
            const extra = parseInt(prompt('Add how many minutes?', '5'));
            if (extra && extra > 0) {
                taskTimeRemaining += extra * 60;
                taskOriginalDuration += extra * 60;
                updateTaskTimerDisplay();
            }
        }

        // Initialize page
        window.onload = () => {
            checkForNewDay();
            loadQuote();
            loadTasks();
            loadTodaysMood();
            updateTimerDisplay();
            updateFocusTimerVisibility();
            loadNotes();
            renderDateStrip();
        };

        openDailyLogBtn.addEventListener('click', () => openDailyLog());
        monthLabelEl.addEventListener('click', toggleMonthDropdown);
    </script>
</body>
</html>